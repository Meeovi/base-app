"use strict";"use client";var S=Object.defineProperty;var Y=Object.getOwnPropertyDescriptor;var z=Object.getOwnPropertyNames;var J=Object.prototype.hasOwnProperty;var Q=(i,e)=>{for(var a in e)S(i,a,{get:e[a],enumerable:!0})},X=(i,e,a,p)=>{if(e&&typeof e=="object"||typeof e=="function")for(let t of z(e))!J.call(i,t)&&t!==a&&S(i,t,{get:()=>e[t],enumerable:!(p=Y(e,t))||p.enumerable});return i};var Z=i=>X(S({},"__esModule",{value:!0}),i);var oe={};Q(oe,{CheckoutContext:()=>P,CheckoutFormContext:()=>y,CheckoutFormProvider:()=>H,CheckoutProvider:()=>B,useCheckout:()=>E,useCheckoutForm:()=>L});module.exports=Z(oe);var A=require("@polar-sh/sdk/models/errors/alreadyactivesubscriptionerror.js"),U=require("@polar-sh/sdk/models/errors/httpvalidationerror"),V=require("@polar-sh/sdk/models/errors/notopencheckout.js"),q=require("@polar-sh/sdk/models/errors/paymenterror.js"),N=require("@polar-sh/sdk/models/errors/paymentnotready.js"),d=require("react"),O=require("react-hook-form");var R=(i,e,a=1,p)=>{i.forEach(t=>{let o=t.loc.slice(a);p&&p.includes(o[0])&&(o=o.slice(1));for(let u=0;u<o.length&&!(!Number.isInteger(o[u])&&(o[u]=o[u].replace(/_([a-z])/g,f=>f[1].toUpperCase()),o[u]==="customFieldData"));u++);e(o.join("."),{type:t.type,message:t.msg})})};var _=require("@polar-sh/sdk/core"),D=require("@polar-sh/sdk/funcs/checkoutsClientConfirm"),T=require("@polar-sh/sdk/funcs/checkoutsClientGet"),I=require("@polar-sh/sdk/funcs/checkoutsClientUpdate"),c=require("react"),K=require("react/jsx-runtime"),$=()=>{throw new Error("You forgot to wrap your component in <CheckoutProvider>.")},P=(0,c.createContext)($),B=({clientSecret:i,serverURL:e,server:a,children:p})=>{let t=(0,c.useMemo)(()=>new _.PolarCore({server:a,serverURL:e}),[a,e]),[o,u]=(0,c.useState)(null);(0,c.useEffect)(()=>{(0,T.checkoutsClientGet)(t,{clientSecret:i}).then(({ok:m,value:n,error:g})=>{if(m)u(n);else throw g})},[t,i]);let f=(0,c.useCallback)(async()=>{let m=await(0,T.checkoutsClientGet)(t,{clientSecret:i});return m.ok&&u(m.value),m},[t,i]),b=(0,c.useCallback)(async m=>{let n=await(0,I.checkoutsClientUpdate)(t,{clientSecret:i,checkoutUpdatePublic:m});return n.ok&&u(n.value),n},[t,i]),C=(0,c.useCallback)(async m=>{let n=await(0,D.checkoutsClientConfirm)(t,{clientSecret:i,checkoutConfirmStripe:m});return n.ok&&u(n.value),n},[t,i]);return o?(0,K.jsx)(P.Provider,{value:{checkout:o,refresh:f,update:b,confirm:C,client:t},children:p}):null},E=()=>(0,c.useContext)(P);var j=require("react/jsx-runtime"),ee=()=>{throw new Error("You forgot to wrap your component in <CheckoutFormProvider>.")},y=(0,d.createContext)(ee),H=({children:i})=>{let{checkout:e,update:a,confirm:p}=E(),[t,o]=(0,d.useState)(!1),[u,f]=(0,d.useState)(),[b,C]=(0,d.useState)(!1),m=(0,O.useForm)({defaultValues:{...e,customerBillingAddress:e.customerBillingAddress,discountCode:e.discount?e.discount.code:void 0},shouldUnregister:!0}),{setError:n}=m,g=(0,d.useCallback)(async s=>{C(!0);let{ok:h,value:k,error:r}=await a(s).finally(()=>{C(!1)});if(h)return k;throw r instanceof U.HTTPValidationError?R(r.detail||[],n):(r instanceof A.AlreadyActiveSubscriptionError||r instanceof V.NotOpenCheckout||r instanceof q.PaymentError||r instanceof N.PaymentNotReady)&&n("root",{message:r.detail}),r},[a,n]),v=(0,d.useCallback)(async s=>{let{ok:h,value:k,error:r}=await p(s);if(h)return k;throw r instanceof U.HTTPValidationError?R(r.detail||[],n):(r instanceof A.AlreadyActiveSubscriptionError||r instanceof V.NotOpenCheckout||r instanceof q.PaymentError||r instanceof N.PaymentNotReady)&&n("root",{message:r.detail}),r},[p,n]),G=(0,d.useCallback)(async(s,h,k)=>{if(o(!0),!e.isPaymentFormRequired){f("Processing order...");try{return await v(s)}catch(l){throw l}finally{o(!1)}}if(!h||!k)throw o(!1),new Error("Stripe elements not provided");f("Processing payment");let{error:r}=await k.submit();if(r)throw r.type!=="validation_error"&&n("root",{message:r.message}),o(!1),new Error(r.message);let x,w;try{let l=await h.createConfirmationToken({elements:k,params:{payment_method_data:{billing_details:{name:s.customerName,email:s.customerEmail,address:{line1:s.customerBillingAddress?.line1||null,line2:s.customerBillingAddress?.line2||null,postal_code:s.customerBillingAddress?.postalCode||null,city:s.customerBillingAddress?.city||null,state:s.customerBillingAddress?.state||null,country:s.customerBillingAddress?.country||null},phone:null}}}});x=l.confirmationToken,w=l.error}catch(l){throw o(!1),l}if(!x||w)throw n("root",{message:w?.message||"Failed to create confirmation token, please try again later."}),o(!1),new Error("Failed to create confirmation token, please try again later.");let F;try{F=await v({...s,confirmationTokenId:x.id})}catch(l){throw o(!1),l}f("Payment successful! Getting your products ready...");let{intent_status:M,intent_client_secret:W}=F.paymentProcessorMetadata;if(M==="requires_action"){let{error:l}=await h.handleNextAction({clientSecret:W});if(l)throw o(!1),n("root",{message:l.message}),new Error(l.message)}return o(!1),F},[e,n,v]);return(0,j.jsx)(y.Provider,{value:{checkout:e,form:m,update:g,confirm:G,loading:t,loadingLabel:u,isUpdatePending:b},children:i})},L=()=>(0,d.useContext)(y);0&&(module.exports={CheckoutContext,CheckoutFormContext,CheckoutFormProvider,CheckoutProvider,useCheckout,useCheckoutForm});
