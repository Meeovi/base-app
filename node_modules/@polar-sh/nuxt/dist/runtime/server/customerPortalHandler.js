import { Polar } from "@polar-sh/sdk";
import { createError, sendRedirect } from "h3";
export const CustomerPortal = ({
  accessToken,
  server,
  getCustomerId,
  returnUrl
}) => {
  return async (event) => {
    const retUrl = returnUrl ? new URL(returnUrl) : void 0;
    const customerId = await getCustomerId(event);
    if (!customerId) {
      console.error(
        "Failed to redirect to customer portal, customerId not defined"
      );
      throw createError({
        statusCode: 400,
        message: "customerId not defined"
      });
    }
    try {
      const polar = new Polar({
        accessToken,
        server
      });
      const result = await polar.customerSessions.create({
        customerId,
        returnUrl: retUrl ? decodeURI(retUrl.toString()) : void 0
      });
      return sendRedirect(event, result.customerPortalUrl);
    } catch (error) {
      console.error("Failed to redirect to customer portal", error);
      throw createError({
        statusCode: 500,
        statusMessage: error.message,
        message: error.message ?? "Internal server error"
      });
    }
  };
};
