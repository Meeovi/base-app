(function(h,p){typeof exports=="object"&&typeof module<"u"?module.exports=p(require("handlebars/dist/cjs/handlebars")):typeof define=="function"&&define.amd?define(["handlebars/dist/cjs/handlebars"],p):(h=typeof globalThis<"u"?globalThis:h||self,h.StudioSdkPlugins_dataSourceHandlebars=p(h.Handlebars))})(this,function(h){"use strict";const p="app.grapesjs.com",P="app-stage.grapesjs.com",S=[p,"app2.grapesjs.com",P,"app-stage2.grapesjs.com","localhost","127.0.0.1",".local-credentialless.webcontainer.io",".local.webcontainer.io","-sandpack.codesandbox.io"],E="license:check:start",x="license:check:end",I=()=>typeof window<"u",C=({isDev:i,isStage:t})=>`${i?"":`https://${t?P:p}`}/api`,k=()=>{const i=I()&&window.location.hostname;return!!i&&(S.includes(i)||S.some(t=>i.endsWith(t)))};async function N({path:i,baseApiUrl:t,method:e="GET",headers:n={},params:s,body:a}){const o=`${t||C({isDev:!1,isStage:!1})}${i}`,c={method:e,headers:{"Content-Type":"application/json",...n}};a&&(c.body=JSON.stringify(a));const u=s?new URLSearchParams(s).toString():"",l=u?`?${u}`:"",m=await fetch(`${o}${l}`,c);if(!m.ok)throw new Error(`HTTP error! status: ${m.status}`);return m.json()}var d=(i=>(i.free="free",i.startup="startup",i.business="business",i.enterprise="enterprise",i))(d||{});const y={[d.free]:0,[d.startup]:10,[d.business]:20,[d.enterprise]:30};function _(i){const t=i;return t.init=e=>n=>i(n,e),t}const T=i=>_(i);async function v({editor:i,plan:t,pluginName:e,licenseKey:n,cleanup:s}){let a="",r=!1;const o=k(),c=l=>{console.warn("Cleanup plugin:",e,"Reason:",l),s()},u=(l={})=>{var $;const{error:m,sdkLicense:H}=l,g=($=l.plan)==null?void 0:$.category;if(!(H||l.license)||m)c(m||"Invalid license");else if(g){const U=y[t],B=y[g];U>B&&c({pluginRequiredPlan:t,licensePlan:g})}};i.on(E,l=>{a=l==null?void 0:l.baseApiUrl,r=!0}),i.on(x,l=>{u(l)}),setTimeout(async()=>{if(!r){if(o)return;if(n){const l=await O({licenseKey:n,pluginName:e,baseApiUrl:a});l&&u(l)}else c("The `licenseKey` option not provided")}},2e3)}async function O(i){const{licenseKey:t,pluginName:e,baseApiUrl:n}=i;try{return(await N({baseApiUrl:n,path:`/sdk/${t||"na"}`,method:"POST",params:{d:window.location.hostname,pn:e}})).result||{}}catch(s){return console.error("Error during SDK license check:",s),!1}}const L=(i,t)=>(i.config.optsHtml={...i.config.optsHtml,exporter:t},()=>{i.config.optsHtml.exporter=void 0}),A=(i,t)=>{const e=s=>{const{input:a}=s,{contains:r}=t;(!r||a.includes(r))&&(s.input=t.importer.import(a))},n=i.Parser.events.htmlBefore;return i.on(n,e),()=>{i.off(n,e)}},b={equals:"equals",isTruthy:"isTruthy",isFalsy:"isFalsy",isDefined:"isDefined",isNull:"isNull",isUndefined:"isUndefined",isArray:"isArray",isObject:"isObject",isString:"isString",isNumber:"isNumber",isBoolean:"isBoolean",isDefaultValue:"isDefaultValue"},w={...b,...{">":"numGt","<":"numLt",">=":"numGte","<=":"numLte","=":"numEq","!=":"numNeq"},...{contains:"strContains",startsWith:"strStartsWith",endsWith:"strEndsWith",equalsIgnoreCase:"strEqualsIgnoreCase",trimEquals:"strTrimEquals"}};class j{getHelperId(t){return w[t]||t}getFullPath({collectionId:t,path:e}){let n=e;return t&&(n=[this._sanitizeVariableName(t),e].filter(Boolean).join(".")),n||""}getVariableSyntax({dataResolver:t}){const{defaultValue:e}=t,n=this.getFullPath(t);return e?`{{#if ${n}}}{{{${n}}}}{{else}}${e}{{/if}}`:`{{{${n}}}}`}getCollectionStartSyntax({dataResolver:t}){const{collectionId:e,dataSource:n}=t,s=n==null?void 0:n.path;let a="";if(t.startIndex!==void 0||t.endIndex!==void 0){const u=t.startIndex??0,l=t.endIndex!==void 0?t.endIndex:"";l!==""?a=` (slice ${s} ${u} ${l})`:a=` (slice ${s} ${u})`}const o=` as |${this._sanitizeVariableName(e)}|`;return`{{#each ${a||s}${o}}}`}getCollectionEndSyntax(){return"{{/each}}"}getConditionalStartSyntax({dataResolver:t}){const e=t.condition;if(!e)return"";const n=e,s=e;if(s.statements&&s.logicalOperator==="and"||s.logicalOperator==="or"){const{statements:a}=s,r=s.logicalOperator,o=a.map(u=>this._parseCondition(u)).join(" ");return`{{#if ${a.length>1?`(${r} ${o})`:o}}}`}else return`{{#if ${this._parseCondition(n)}}}`}_parseCondition(t){if(!t)return"";const e=t,n=t;if(n.statements&&n.logicalOperator==="and"||n.logicalOperator==="or"){const{statements:s}=n,a=n.logicalOperator,r=n.statements.map(o=>this._parseCondition(o)).join(" ");return s.length>1?`(${a} ${r})`:r}else{const s=e.operator,a=this.getHelperId(s),r=this._parseValue(e.left),o=this._parseValue(e.right);return this.getExpressionStr(a,r,o)}}getExpressionStr(t,e,n){return b[t]?t==="isTruthy"?e:t==="isFalsy"?`!${e}`:`${t} ${e}`:`(${t} ${e} ${n})`}_parseValue(t){return typeof t=="object"?this.getFullPath(t):typeof t=="string"?`'${t.replace(/'/g,"\\'")}'`:String(t)}_sanitizeVariableName(t){return t.replace(/[^a-zA-Z0-9_$]/g,"_")}getConditionElseSyntax(){return"{{else}}"}getConditionalEndSyntax(){return"{{/if}}"}}class D{constructor(){this.messages=[],this.collectionStack=[]}import(t){this.messages=[],this.collectionStack=[];const e=this.parse(t);return this.astToGrapesJS(e)}parse(t){try{return h.parse(t)}catch(e){if(e instanceof Error&&e.message.includes("Parse error")){const n=e.message.match(/line (\d+)/),s=n?parseInt(n[1]):0,a=e.message.match(/column (\d+)/),r=a?parseInt(a[1]):0;throw new Error(`Handlebars syntax error at line ${s}, column ${r}: ${e.message}`)}throw e}}astToGrapesJS(t){switch(t.type){case"Program":return this.handleProgram(t);case"ContentStatement":return this.handleContentStatement(t);case"MustacheStatement":return this.handleMustacheStatement(t);case"BlockStatement":return this.handleBlockStatement(t);case"PartialStatement":return this.handlePartialStatement(t);case"CommentStatement":return this.handleCommentStatement(t);case"ElementNode":return this.handleElementNode(t);case"TextNode":return this.handleTextNode(t);default:return this.addMessage("warning",`Unsupported node type: ${t.type}`,t.loc),""}}handleProgram(t){let e="";if(t.body)for(const n of t.body)e+=this.astToGrapesJS(n);return e}handleContentStatement(t){return t.value||""}handleMustacheStatement(t,e={}){const n=this.getExpressionString(t.path),s={...e};return this.collectionStack.length>0?this.processPathWithCollectionContext(n,s):s.path=n,`<data-variable data-gjs-data-resolver='${JSON.stringify(s)}'></data-variable>`}processPathWithCollectionContext(t,e){t.startsWith("@")?this.handleDirectCollectionReference(t,e):this.handleRelativePathReference(t,e)}handleDirectCollectionReference(t,e){if(this.isSpecialIterationVariable(t)){this.setSpecialVariableResolver(this.collectionStack[this.collectionStack.length-1],t,e);return}const[n,...s]=t.substring(1).split("/"),a=s.join(".");this.collectionStack.includes(n)?this.setCurrentItemResolver(n,a,e):this.handleParentReferenceFallback(t,e)}isSpecialIterationVariable(t){return["index","@index","key","@key"].includes(t)}setSpecialVariableResolver(t,e,n){n.collectionId=t;const s={index:"currentIndex","@index":"currentIndex",key:"currentKey","@key":"currentKey"};n.variableType=s[e]}setCurrentItemResolver(t,e,n){n.collectionId=t,n.variableType="currentItem",e&&(n.path=e)}handleRelativePathReference(t,e){const n=f(t),{parentLevel:s,remainingPathParts:a}=this.calculateParentLevel(n),r=a.join("."),o=this.collectionStack.length-1-s;o>=0&&o<this.collectionStack.length?this.resolveRelativePath(r,o,e):e.path=a.join(".")}calculateParentLevel(t){const e=this.collectionStack.findLastIndex(a=>a===t[0]);if(e!==-1)return{parentLevel:this.collectionStack.length-1-e,remainingPathParts:t.slice(1)};let n=0;const s=[...t];for(;s[0]==="..";)n++,s.shift();return{parentLevel:n,remainingPathParts:s}}resolveRelativePath(t,e,n){const s=this.collectionStack[e];n.collectionId=s,n.variableType="currentItem",t!=="this"&&(n.path=t.startsWith("this.")?t.split(".").slice(1).join("."):t)}handleParentReferenceFallback(t,e){const n=f(t),{parentLevel:s,remainingPathParts:a}=this.calculateParentLevel(n),r=a.join("."),o=this.collectionStack.length-1-s;o>=0&&o<this.collectionStack.length?this.resolveRelativePath(r,o,e):e.path=a.join(".")}handleBlockStatement(t){const e=t.path.original;switch(e){case"if":case"unless":return this.handleConditionalBlock(t,e);case"each":return this.handleEachBlock(t);default:return this.addMessage("warning",`Unsupported block helper: ${e}`,t.loc),this.handleGenericBlock(t)}}handleConditionalBlock(t,e){const a={logicalOperator:"and",statements:[{left:{type:"data-variable",path:this.getExpressionString(t.params[0])},operator:e==="unless"?"isFalsy":"isTruthy"}]},r=this.handleProgram(t.program),o=t.inverse?this.handleProgram(t.inverse):"";return`
      <data-condition data-gjs-data-resolver='${JSON.stringify({condition:a})}'>
        <data-condition-true-content>${r}</data-condition-true-content>
        <data-condition-false-content>${o}</data-condition-false-content>
      </data-condition>
    `}handleEachBlock(t){var a,r,o;const e=this.getExpressionString(t.params[0]);let n;t.params.length>=3&&t.params[1]==="as"&&((a=t.params[2])==null?void 0:a.type)==="PathExpression"?n=t.params[2].original:(o=(r=t.program)==null?void 0:r.blockParams)!=null&&o.length?n=t.program.blockParams[0]:n=`collection-${Math.random().toString(36).substring(2,10)}`,this.collectionStack.push(n);const s=this.handleProgram(t.program);return this.collectionStack.pop(),`
      <data-collection data-gjs-data-resolver='${JSON.stringify({dataSource:{type:"data-variable",path:e},collectionId:n})}'>
        <data-collection-item>${s}</data-collection-item>
      </data-collection>
    `}handleCommentStatement(t){return`<!--${t.value}-->`}handleElementNode(t){let e="";if(t.attributes)for(const s of t.attributes)s.value.type==="TextNode"?e+=` ${s.name}="${s.value.chars}"`:(this.addMessage("warning",`Complex attribute values not fully supported: ${s.name}`,t.loc),e+=` ${s.name}="${this.getExpressionString(s.value)}"`);let n="";if(t.children)for(const s of t.children)n+=this.astToGrapesJS(s);return`<${t.tag}${e}>${n}</${t.tag}>`}handleTextNode(t){return t.chars||""}handlePartialStatement(t){return this.addMessage("warning",`Partials are not fully supported: ${t.name.original}`,t.loc),`{{> ${t.name.original}}}`}handleGenericBlock(t){const e=this.handleProgram(t.program);return`<!-- Unsupported block: ${t.path.original} -->${e}`}getExpressionString(t){return t.type==="PathExpression"?t.original:t.type==="StringLiteral"?t.value:t.type==="NumberLiteral"?t.value.toString():t.type==="BooleanLiteral"?t.value?"true":"false":t.type==="SubExpression"?this.getExpressionString(t.params[0]):t.type==="Hash"?`{${t.pairs.map(n=>`${n.key}=${this.getExpressionString(n.value)}`).join(", ")}}`:(this.addMessage("warning",`Complex expression type not fully supported: ${t.type}`,t.loc),"")}addMessage(t,e,n){this.messages.push({type:t,message:e,location:n?{line:n.start.line,column:n.start.column}:void 0})}}const f=i=>{if(i==null||i==="")return[];if(i===".")return["this"];if(i===".."||i==="../")return[".."];if(i.startsWith("../")){const r=i.substring(3);return["..",...f(r)]}const t=[];let e=0,n=i.replace(/\[(?:(['"])(.*?)\1|([^\]]*))\]/g,(r,o,c,u)=>{const l=c!==void 0?c:u||"";return t[e]=l,`__HANDLEBARS_PLACEHOLDER_${e++}__`});n=n.replace(/\//g,".");const s=n.split("."),a=[];for(const r of s){const o=/^__HANDLEBARS_PLACEHOLDER_(\d+)__$/.exec(r);if(o){const c=parseInt(o[1],10);a.push(t[c])}else r!==""&&a.push(r)}return a},M="dataSourceHandlebars",R=d.startup;return T(function(i,t={}){const e=L(i,new j),n=A(i,{contains:"{{",importer:new D});v({editor:i,licenseKey:t.licenseKey,plan:R,pluginName:M,cleanup:()=>{e(),n()}})})});
