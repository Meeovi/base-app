(function(P,R){typeof exports=="object"&&typeof module<"u"?module.exports=R():typeof define=="function"&&define.amd?define(R):(P=typeof globalThis<"u"?globalThis:P||self,P.StudioSdkPlugins_canvasAbsoluteMode=R())})(this,function(){"use strict";const P="app.grapesjs.com",R="app-stage.grapesjs.com",W=[P,"app2.grapesjs.com",R,"app-stage2.grapesjs.com","localhost","127.0.0.1",".local-credentialless.webcontainer.io",".local.webcontainer.io","-sandpack.codesandbox.io"],H="license:check:start",X="license:check:end",F=()=>typeof window<"u",q=({isDev:e,isStage:a})=>`${e?"":`https://${a?R:P}`}/api`,J=()=>{const e=F()&&window.location.hostname;return!!e&&(W.includes(e)||W.some(a=>e.endsWith(a)))};function z(e){return typeof e=="function"}async function Q({path:e,baseApiUrl:a,method:h="GET",headers:l={},params:f,body:o}){const n=`${a||q({isDev:!1,isStage:!1})}${e}`,m={method:h,headers:{"Content-Type":"application/json",...l}};o&&(m.body=JSON.stringify(o));const d=f?new URLSearchParams(f).toString():"",t=d?`?${d}`:"",i=await fetch(`${n}${t}`,m);if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);return i.json()}var L=(e=>(e.free="free",e.startup="startup",e.business="business",e.enterprise="enterprise",e))(L||{});const Y={[L.free]:0,[L.startup]:10,[L.business]:20,[L.enterprise]:30};function Z(e){const a=e;return a.init=h=>l=>e(l,h),a}const ee=e=>Z(e);async function te({editor:e,plan:a,pluginName:h,licenseKey:l,cleanup:f}){let o="",s=!1;const n=J(),m=t=>{console.warn("Cleanup plugin:",h,"Reason:",t),f()},d=(t={})=>{var E;const{error:i,sdkLicense:p}=t,c=(E=t.plan)==null?void 0:E.category;if(!(p||t.license)||i)m(i||"Invalid license");else if(c){const b=Y[a],v=Y[c];b>v&&m({pluginRequiredPlan:a,licensePlan:c})}};e.on(H,t=>{o=t==null?void 0:t.baseApiUrl,s=!0}),e.on(X,t=>{d(t)}),setTimeout(async()=>{if(!s){if(n)return;if(l){const t=await ne({licenseKey:l,pluginName:h,baseApiUrl:o});t&&d(t)}else m("The `licenseKey` option not provided")}},2e3)}async function ne(e){const{licenseKey:a,pluginName:h,baseApiUrl:l}=e;try{return(await Q({baseApiUrl:l,path:`/sdk/${a||"na"}`,method:"POST",params:{d:window.location.hostname,pn:h}})).result||{}}catch(f){return console.error("Error during SDK license check:",f),!1}}const oe="canvasAbsoluteMode",se=L.startup,ie=(e,a,h)=>{var d,t;const l=h.enableAbsolute??(i=>i.hasAbsolute),o=(Array.isArray(a)?a:a?[a]:[...e.getSelectedAll()])[0],s=((t=(d=o==null?void 0:o.delegate)==null?void 0:d.move)==null?void 0:t.call(d,o))||o;if(!s)return;const n=s.getEl();return{result:z(l)?l({component:s,hasAbsolute:!!n&&getComputedStyle(n).position==="absolute"}):!1,component:s,dmode:s.get("dmode")}};function G({guideMatched:e,canvasView:a}){var N;const h=e.guide.x===void 0?"y":"x";let l=0,f=0,o=0,s=0;const{guide:n,matched:m}=e,d=a.getElBoxRect(n.componentView.el),t=a.getElBoxRect(((N=m.componentView)==null?void 0:N.el)||m.componentEl),i=d.y,p=d.y+d.height,c=d.x,S=d.x+d.width,E=t.y,b=t.y+t.height,v=t.x,_=t.x+t.width,x=Math.max(0,i-b),u=Math.max(0,E-p),C=Math.max(0,c-_),M=Math.max(0,v-S),r=x>u,g=C>M,y=n.type;return h==="x"&&(y==="l"?(l=c,r?(f=b,o=x):(f=p,o=u)):y==="r"?(l=S,r?(f=b,o=x):(f=p,o=u)):y==="x"&&(l=c-(c-S)/2,r?(f=b,o=x):(f=p,o=u))),h==="y"&&(y==="t"?(f=i,g?(l=_,s=C):(l=S,s=M)):y==="b"?(f=p,g?(l=_,s=C):(l=S,s=M)):y==="y"&&(f=i-(i-p)/2,g?(l=_,s=C):(l=S,s=M))),{axis:h,x:l,y:f,width:s,height:o}}function ce({guideMatched:e,component:a,canvasView:h}){const l=e.guide.x===void 0?"x":"y",{guide:f,matched:o}=e,s=f.type,n=o.type,m=h.getElementPos(f.componentView.el).rect,d=h.getElementPos(o.componentView.el).rect;if(l==="x"){const t=m.height,i=d.top,p=d.top+d.height;let c=0;s==="t"?n==="t"?c=i-t:n==="b"?c=p-t:n==="y"&&(c=i-t-(i-p)/2):s==="b"?n==="t"?c=i-t*2:n==="b"?c=p-t*2:n==="y"&&(c=i-t*2-(i-p)/2):s==="y"&&(n==="t"?c=i-t*1.5:n==="b"?c=p-t*1.5:n==="y"&&(c=i-t*1.5-(i-p)/2)),a.addStyle({top:`${c-5}px`},{partial:!0})}if(l==="y"){const t=m.width,i=d.left,p=d.left+d.width;let c=0;s==="l"?n==="l"?c=i:n==="r"?c=p:n==="x"&&(c=i-(i-p)/2):s==="r"?n==="l"?c=i-t:n==="r"?c=p-t:n==="x"&&(c=i-t-(i-p)/2):s==="x"&&(n==="l"?c=i-t/2:n==="r"&&(c=p-t/2)),a.addStyle({left:`${c}px`},{partial:!0})}}function k({snapping:e,editor:a,props:h}){var B,w;const{command:l,guidesMatched:f}=h,o=h.component,s=o.getEl(),n=a.Canvas.getCanvasView(),{x:m,y:d}=e??{x:10,y:10},t=l.opts.event,i=t.clientX,p=t.clientY;if(!o.__lastSnappedPosition){const A=n.getElBoxRect(s),D=i-A.x,T=p-A.y;o.__lastSnappedPosition={left:A.x,top:A.y},o.__dragOffset={x:D,y:T}}const c=((B=o.__dragOffset)==null?void 0:B.x)||0,S=((w=o.__dragOffset)==null?void 0:w.y)||0,E=o.__lastSnappedPosition,b=i-E.left-c,v=p-E.top-S;let _=E.left,x=E.top;const u=f==null?void 0:f[0],C=(u==null?void 0:u.guide.type)==="l",M=(u==null?void 0:u.guide.type)==="x",r=(u==null?void 0:u.guide.type)==="r",g=(u==null?void 0:u.guide.type)==="t",y=(u==null?void 0:u.guide.type)==="b",N=(u==null?void 0:u.guide.type)==="y";if(u){const{x:A,y:D}=G({guideMatched:u,canvasView:n}),T=s.offsetWidth,I=s.offsetHeight;C?_=A:r?_=A-T:M?_=A-T/2:g?x=D:y?x=D-I:N&&(x=D-I/2),o.__lastSnappedGuideMatched=u}else Math.abs(b)>=m&&(_=Math.round((E.left+b)/m)*m,o.__lastSnappedGuideMatched=null),Math.abs(v)>=d&&(x=Math.round((E.top+v)/d)*d,o.__lastSnappedGuideMatched=null);return o.addStyle({left:`${_}px`,top:`${x}px`},{partial:!0}),o.__lastSnappedPosition={left:_,top:x},{x:_,y:x,guideMatched:o.__lastSnappedGuideMatched}}function ae({snapping:e,props:a,editor:h}){const{x:l,y:f}=k({snapping:e,props:a,editor:h}),o=a.component;o.addStyle({left:`${l}px`,top:`${f}px`}),delete o.__lastSnappedPosition,delete o.__lastSnappedGuideMatched}const le="core:component-drag",de="studio:setDragAbsolute",fe="dmode:start",K="dmode:move",V="dmode:end",U="dragAbsolute",re="select",pe="hover",ue="spacing";return ee(function(e,a={}){const{Commands:h}=e,l=h.events,f=h.getConfig().defaultOptions??{},o=`${l.runBeforeCommand}tlb-move`;f[le]={run:r=>({...r,skipGuidesRender:!0})};const{snapping:s,locking:n,globalAbsolute:m=!0}=a;m&&e.setDragMode("absolute");const d=!!(s!=null&&s.x||s!=null&&s.y),t=!!(n!=null&&n.x||n!=null&&n.y),{Canvas:i}=e;let p=null;const c=r=>{const{component:g,guidesMatched:y,command:N}=r,B=g.view,w=e.Canvas.getCanvasView(),A=g.getEl();let D=y.map(O=>O.matched.componentEl),T=y.map(O=>G({guideMatched:O,canvasView:w}));if(d){const{guideMatched:O}=k({snapping:s,props:r,editor:e});O?(D=[O.matched.componentEl],T=[G({guideMatched:O,canvasView:w})]):(D=[],T=[])}if(t)if(N.opts.event.shiftKey)if(!p)p=y[0];else{const $=p,j=$.guide.x===void 0?"x":"y";(j==="x"&&(n==null?void 0:n.x)||j==="y"&&(n==null?void 0:n.y))&&(ce({guideMatched:$,component:g,canvasView:w}),D=[$.matched.componentEl],T=[G({guideMatched:$,canvasView:w})])}else p=null;const I={id:U,type:U,component:g,componentView:B,originComponent:A,matchedComponents:D,originMatchedDistances:T};i.addSpot(I)},S=({enabled:r})=>{e.runCommand(de,{enabled:r})},E=({type:r})=>{i.removeSpots({type:r})},b=()=>{E({type:re}),E({type:pe}),E({type:ue})},v=r=>{S({enabled:!0}),c(r),b()},_=r=>{c(r),b()},x=r=>{E({type:U}),d&&ae({snapping:s,props:r,editor:e}),S({enabled:!1})},M=[[fe,r=>{v(r),e.on(K,_);const g=()=>{x(r),e.off(K,_),e.off(V,g)};e.on(V,g)}],[o,r=>{if(m)return;const g=r.options.target,y=ie(e,g,a);y!=null&&y.result&&!y.dmode&&(r.options.mode="absolute")}]];M.forEach(([r,g])=>e.on(r,g)),te({editor:e,licenseKey:a.licenseKey,plan:se,pluginName:oe,cleanup:()=>{S({enabled:!1}),M.forEach(([r,g])=>e.off(r,g))}})})});
